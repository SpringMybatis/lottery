<!DOCTYPE HTML>
<html>
<head>
    <meta name="viewport" content="user-scalable=no"/>
    <title>天逸集团2017抽奖</title>
    <style>
        .center{
            position:absolute;
            top:50%;
            left:50%;
            margin:-110px 0 0 -200px;
            width:400px;
            height:220px;
            z-index:99;
            text-align: center;
            font-size: 150px;
            font-family: "微软雅黑";
            color: #BF211D;
        }
        .btn{
            border:5px solid #BF211D;
            border-radius: 50px;
            box-shadow: 20px 20px 10px #888888;
        }
    </style>
    <script type="text/javascript" src="dist/js/jquery.min.js"></script>
    <script type="text/javascript" src="dist/js/jquery.mobile-1.3.2.min.js"></script>
    <script>
        $(function(){

            var status = -1;
            var process = ['READY','LOTTERY','START','STOP'];
            var processView = ['准备','抽奖','开始','停止'];

            var websocket = null;

            //判断当前浏览器是否支持WebSocket
            if('WebSocket' in window){
                websocket = new WebSocket("ws://localhost/websocket/operation");
            }
            else{
                alert('Not support websocket')
            }

            //连接发生错误的回调方法
            websocket.onerror = function(){
                alert("链接断开");
                status = -1;
            };

            //连接成功建立的回调方法
            websocket.onopen = function(event){
                status = 0;
            };

            //接收到消息的回调方法
            websocket.onmessage = function(event){
                console.log(event.data);
                switch (event.data){

                    case 'CONNECTED':
                        break;
                    case 'MSG':
                        ++status;
                        console.log(status);
                        if(status >= process.length){
                            status = 0;
                            addSwipeEvent();
                        }
                        else if(status == 2){
                            addClickEvent();
                        }
                        $("#msg").text(processView[status]);
                        break;
                }
            };

            //连接关闭的回调方法
            websocket.onclose = function(){
                status = -1;
            };

            //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。
            window.onbeforeunload = function(){
                websocket.close();
            };

            //将消息显示在网页上
            function setMessage(innerHTML){
            }

            //关闭连接
            function closeWebSocket(){
                websocket.close();
            }

            //发送消息
            function send(command){
                websocket.send(command);
            }
            function addSwipeEvent(){
                $(document).off();
                $("#msg").off();
                $("#msg").removeClass("btn");
                $(document).on("swipeleft",function(){
                    if(status > -1){
                        console.log("swipe"+status);
                        send(process[status]);
                    }
                });
            }
            function addClickEvent(){
                $(document).off();
                $("#msg").addClass("btn");
                $("#msg").on("click",function(e,d){
                    if(status > -1){
                        console.log(e);
                        console.log("click"+status);
                        send(process[status]);
                    }
                });
            }

            addSwipeEvent();


        })
    </script>
</head>

<body style="background-image: url('style/oper-bg.png');background-size: 100%;background-repeat: no-repeat;">
<div class="center" id="msg">
准备
</div>
</body>



<script type="text/javascript">

</script>
</html>